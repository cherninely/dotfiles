#!/usr/bin/env bash
# alias wcnew # is a wrapper for do `cd` at end of WC creating

# ####################
# INIT
# ####################

if [[ $# < 2 ]]; then
    echo 'Usage:'
    echo 'wcnew tmp images3               # –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç'
    echo 'wcnew tmp video_touch_phone -m  # –°–æ —Å–±–æ—Ä–∫–æ–π (--make)'
    echo 'wcnew tmp images/deskpad -m     # –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç'
    echo 'wcnew tmp fiji -m               # —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ —Å–±–æ—Ä–∫–∞ —Ü–µ–ª–∏–∫–æ–º'
    echo 'wcnew wc1 images3+video3+web3   # –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç–æ–≤'
    echo 'wcnew tmp web4 -m               # –°–ï–†–ü (-m = make build)'
    exit
fi

#
# filter, rearrange and read opts
eval set -- "`getopt -o "m,t,b:" --long "make,tmux,branch:" -- "$@"`"
while [[ $1 != --  ]]; do case $1 in
    -m|--make) IS_MAKE=1;;
    -t|--tmux) IS_TMUX=1;;
    -b|--branch) CLONE_BRANCH=$2; shift 1;;
    *) echo "Unknown param"; exit 1;;
esac; shift 1; done
shift 1; # remove divider (--)

readonly WC_NAME=$1
readonly RAW_PROJECTS=$2
readonly YXWEB_PATH=report/templates/YxWeb
NEXT_ACTIONS_HINT="$(echo -e "\033[32m–î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:\n")"
readonly CLONE_BRANCH_OPT="$([[ $(echo $CLONE_BRANCH) ]] && echo "--branch $CLONE_BRANCH")"

# ####################
# COMMON FUNCTIONS
# ####################

function trim_multiline()
{
    sed -r 's/^\s+|\s+$//g'
}

function open_or_print {
    [[ $(uname) = Darwin && $(which open) ]] && open $1 || echo $1
}


# ####################
#
# FIJI PREPROCESSING
#
# FIJI is the Union Repos of MM
#
# ####################

# —Å–ø–∏—Å–æ–∫ fiji-–ø—Ä–æ–µ–∫—Ç–æ–≤
# delimeter="\n"
# @example images3 video_touch_phone
fiji_projects="$(cat ~/dotfiles/extra/fiji-projects | sort)"
# echo -e debug "fiji_projects:\n" "$fiji_projects"

# —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –≤—Ç–æ—Ä—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
# –ó–∞–º–µ–Ω–∏—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å "+" –Ω–∞ "\n"
given_projects="$(echo $RAW_PROJECTS | sed -r 's/\+/\n/g' | sort)"
# echo -e debug "given_projects:\n" "$given_projects"

# —Ç–æ–ª—å–∫–æ –Ω–µ fiji-–ø—Ä–æ–µ–∫—Ç—ã
given_no_fiji_projects="$(comm -13 <(echo "$fiji_projects") <(echo "$given_projects") | trim_multiline)"
# echo -e debug "given_no_fiji_projects:\n" "$given_no_fiji_projects"

# –ï—Å–ª–∏ –ª–∏ –≤ —Å–ø–∏—Å–∫–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è fiji-–ø—Ä–æ–µ–∫—Ç—ã
given_fiji_projects="$(comm -12 <(echo "$fiji_projects") <(echo "$given_projects") | trim_multiline)"
# echo -e debug "given_fiji_projects:\n" "$given_fiji_projects"

function get_fiji_projects_new_format()
{
    for project in ${given_fiji_projects//\\n/ }; do
        project="${project/3/_desktop}" #images3 -> images_deskpad
        project="${project/_//}" # video_touch_phone -> video/touch_phone
        project="${project//_/-}" # images_deskpad -> video/deskpad
        echo "$project"
    done
}
fiji_projects_new_format="$(get_fiji_projects_new_format)"
echo -e debug "fiji_projects_new_format:\n" "$fiji_projects_new_format"

# fiji-–ø—Ä–æ–µ–∫—Ç—ã (images3, video_touch_phone, –∏ –¥—Ä.) —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –∑–∞–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ fiji
PROJECTS="$given_no_fiji_projects"
if [[ "$given_fiji_projects" ]]; then PROJECTS="fiji\n$PROJECTS"; fi

# ####################
# MAIN FUNCTIONS
# ####################

function setup_repo_variables()
{

    if [[ $PROJECT == fiji || $PROJECT == sansara ]]; then
        ORG=mm-interfaces
        ORG_ALIAS=mm
        REPO="$PROJECT"
    else
        ORG=serp
        ORG_ALIAS=serp
        REPO=${PROJECT//_/-}
    fi

}

function clone_repo()
{

    # MM fiji
    if [[ "$given_fiji_projects" ]]; then

        GIT_CLONE="git clone $CLONE_BRANCH_OPT git@github.yandex-team.ru:$ORG/$REPO ."
        echo $GIT_CLONE
        $GIT_CLONE
        [ $? == 0 ] || exit 1

        # –ó–∞–∫—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª—å(-–∏) —Å–±–æ—Ä–∫–∏
        # –º–µ–Ω—è—Ç—å —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –Ω–∞ –Ω–æ–≤—ã–π
        [[ "$fiji_projects_new_format" ]] && echo "$fiji_projects_new_format" | sed 's/fiji/all/g' > .project

        PROJECT_DIR="~/$WC_NAME"

    # –°–ï–†–ü
    else

        mkdir -p ~/$WC_NAME/$YXWEB_PATH
        ln -s $YXWEB_PATH/$PROJECT $PROJECT
        cd $YXWEB_PATH
        git clone git@github.yandex-team.ru:$ORG/$REPO $PROJECT
        [ $? == 0 ] || exit 1

        PROJECT_DIR="~/$WC_NAME/$PROJECT"

    fi

    # TODO: –°–ï–†–ü & MM —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –ª—é–±—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ —Ç–∏–ø–∞ images-touch-viewer

}

function create_symlinks()
{

    # –°–æ–∑–¥–∞—ë–º —Å–∏–º–ª–∏–Ω–∫ video -> video2 (–∫–æ—Å—Ç—ã–ª—å –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏ video2)
    [[ $PROJECT == video2 ]] && ln -s video2 video && echo '–°–∏–º–ª–∏–Ω–∫–∏ —Å—Ç–∞—Ç–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã'

    # –°–æ–∑–¥–∞—ë–º —Å–∏–º–ª–∏–Ω–∫–∏ web4 -> web3, web_touch_phone (–∫–æ—Å—Ç—ã–ª—å –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏)
    [[ $PROJECT == web4 ]] && ln -s web4 web3 && ln -s web4 web_touch_phone && echo '–°–∏–º–ª–∏–Ω–∫–∏ —Å—Ç–∞—Ç–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã'

}

function build_project()
{

        echo "–ü—Ä–æ–µ–∫—Ç: $PROJECT";
        cd $PROJECT

        if [[ $PROJECT == web4 ]]; then
            sudo make build # –ß—Ç–æ–±—ã –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–æ–ª–≥–∏–µ —Ç–µ—Å—Ç—ã
        elif [[ $PROJECT == sansara ]]; then
            IS_SANSARA=true
        else
            make
        fi

}

function open_or_print_project_link()
{

    if [[ $ORG == "mm-interfaces" ]]; then

        if [[ $PROJECTS =~ sansara ]]; then
            if [[ $PROJECT == sansara ]]; then
                make start
                sleep 1
                open_or_print "http://sansara.ru:8888/images/search?text=Lamborghini"
            fi
        else
            open_or_print "$(wcurl)"
        fi
    fi

}

# ####################
# MAIN LOOP
# ####################

for PROJECT in ${PROJECTS//\\n/ }; do

    echo -e debug "PROJECT:\n" "$PROJECT"

    setup_repo_variables

    mkdir ~/$WC_NAME
    cd ~/$WC_NAME

    clone_repo

    create_symlinks

    if [[ $IS_MAKE ]]; then
        build_project
    else
        NEXT_ACTIONS_HINT="$NEXT_ACTIONS_HINT\nmake"
    fi

    NEXT_ACTIONS_HINT="$NEXT_ACTIONS_HINT\nüìã  –°—Å—ã–ª–∫–∞:\n$(open_or_print_project_link)\n"

done


# ####################
# HINTS
# ####################


# –ï—Å–ª–∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–∞ sansara, —Ç–æ —Å–æ–±—Ä–∞—Ç—å –µ—ë –≤ –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—á–µ—Ä–µ–¥—å,
# –ß—Ç–æ–±—ã –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —É–∂–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
[[ $IS_MAKE && $IS_SANSARA ]] && cd ~/$WC_NAME/sansara && sudo make install # –∞ –ø—Ä–æ—Å—Ç–æ make –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä –∏ –±—Ä–∞—É–∑–µ—Ä

# –í—ã–≤–µ—Å—Ç–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–∏–º –¥–µ–π—Å—Ç–≤–∏—è–º
cd ~/$WC_NAME
echo -e "‚úÖ  $NEXT_ACTIONS_HINT\033[0m"

# –°–æ–∑–¥–∞–µ–º tmux-—Å–µ—Å—Å–∏—é –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ —Ü–∏–∫–ª–∞
if [[ $IS_TMUX == 1 ]]; then
    cd $PROJECT_DIR
    tmux -2 -S /tmp/tm-`whoami` new-session -s $WC_NAME "tmux source-file ~/dotfiles/.tmux-default-session-$ORG_ALIAS"
fi
