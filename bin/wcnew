#!/usr/bin/env bash

# ####################
# INIT
# ####################

if [[ $# < 2 ]]; then
    echo 'Usage:'
    echo 'wcnew tmp images3               # Старый формат'
    echo 'wcnew tmp video_touch_phone -m  # Со сборкой (--make)'
    echo 'wcnew tmp images/deskpad -m     # новый формат'
    echo 'wcnew tmp fiji -m               # развёртывание и сборка целиком'
    echo 'wcnew wc1 images3+video3+web3   # Несколько проектов'
    echo 'wcnew tmp web4 -m               # СЕРП (-m = make build)'
    echo ''
    echo 'Go to working directory:'
    echo 'cd ~/!^ # !^ — первый аргумент предыдущей команды'
    exit
fi

#
# filter, rearrange and read opts
eval set -- "`getopt -o "m,t,b:" --long "make,tmux,branch:" -- "$@"`"
while [[ $1 != --  ]]; do case $1 in
    -m|--make) IS_MAKE=1;;
    -t|--tmux) IS_TMUX=1;;
    -b|--branch) CLONE_BRANCH=$2; shift 1;;
    *) echo "Unknown param"; exit 1;;
esac; shift 1; done
shift 1; # remove divider (--)

readonly WC_NAME=$1
readonly RAW_PROJECTS=$2
readonly YXWEB_PATH=report/templates/YxWeb
NEXT_ACTIONS_HINT=$(echo -e "\033[32m\n Дальнейшие действия:")
readonly CLONE_BRANCH_OPT="$([[ $(echo $CLONE_BRANCH) ]] && echo "--branch $CLONE_BRANCH")"

# ####################
# COMMON FUNCTIONS
# ####################

function trim_multiline()
{
    sed -r 's/^\s+|\s+$//g'
}

function open_or_print {
    [[ $(uname) = Darwin && $(which open) ]] && open $1 || echo $1
}


# ####################
#
# FIJI PREPROCESSING
#
# FIJI is the Union Repos of MM
#
# ####################

# список fiji-проектов
# delimeter="\n"
# @example images3 video_touch_phone
fiji_projects="$(cat ~/dotfiles/extra/fiji-projects | sort)"
# echo -e debug "fiji_projects:\n" "$fiji_projects"

# список проектов переданных вторым параметром
# Заменить разделитель "+" на "\n"
given_projects="$(echo $RAW_PROJECTS | sed -r 's/\+/\n/g' | sort)"
# echo -e debug "given_projects:\n" "$given_projects"

# только не fiji-проекты
given_no_fiji_projects="$(comm -13 <(echo "$fiji_projects") <(echo "$given_projects") | trim_multiline)"
# echo -e debug "given_no_fiji_projects:\n" "$given_no_fiji_projects"

# Если ли в списке проектов для развёртывания fiji-проекты
given_fiji_projects="$(comm -12 <(echo "$fiji_projects") <(echo "$given_projects") | trim_multiline)"
# echo -e debug "given_fiji_projects:\n" "$given_fiji_projects"

function get_fiji_projects_new_format()
{
    for project in ${given_fiji_projects//\\n/ }; do
        project="${project/3/_desktop}" #images3 -> images_deskpad
        project="${project/_//}" # video_touch_phone -> video/touch_phone
        project="${project//_/-}" # images_deskpad -> video/deskpad
        echo "$project"
    done
}
fiji_projects_new_format="$(get_fiji_projects_new_format)"
echo -e debug "fiji_projects_new_format:\n" "$fiji_projects_new_format"

# fiji-проекты (images3, video_touch_phone, и др.) удаляются из списка и заменяются на fiji
PROJECTS="$given_no_fiji_projects"
if [[ "$given_fiji_projects" ]]; then PROJECTS="fiji\n$PROJECTS"; fi

# ####################
# MAIN FUNCTIONS
# ####################

function setup_repo_variables()
{

    if [[ $PROJECT == fiji || $PROJECT == sansara ]]; then
        ORG=mm-interfaces
        ORG_ALIAS=mm
        REPO="$PROJECT"
    else
        ORG=serp
        ORG_ALIAS=serp
        REPO=${PROJECT//_/-}
    fi

}

function clone_repo()
{

    # MM fiji
    if [[ "$given_fiji_projects" ]]; then

        GIT_CLONE="git clone $CLONE_BRANCH_OPT git@github.yandex-team.ru:$ORG/$REPO ."
        echo $GIT_CLONE
        $GIT_CLONE
        [ $? == 0 ] || exit 1

        # Закэшировать цель(-и) сборки
        # менять формат записи проектов на новый
        [[ "$fiji_projects_new_format" ]] && echo "$fiji_projects_new_format" | sed 's/fiji/all/g' > .project

        PROJECT_DIR="~/$WC_NAME"

    # СЕРП
    else

        mkdir -p ~/$WC_NAME/$YXWEB_PATH
        ln -s $YXWEB_PATH/$PROJECT $PROJECT
        cd $YXWEB_PATH
        git clone git@github.yandex-team.ru:$ORG/$REPO $PROJECT
        [ $? == 0 ] || exit 1

        PROJECT_DIR="~/$WC_NAME/$PROJECT"

    fi

    # TODO: СЕРП & MM развёртывание любых репозиториев типа images-touch-viewer

}

function create_symlinks()
{

    # Создаём симлинк video -> video2 (костыль для статики video2)
    [[ $PROJECT == video2 ]] && ln -s video2 video && echo 'Симлинки статики созданы'

    # Создаём симлинки web4 -> web3, web_touch_phone (костыль для статики)
    [[ $PROJECT == web4 ]] && ln -s web4 web3 && ln -s web4 web_touch_phone && echo 'Симлинки статики созданы'

}

function build_project()
{

        echo "Проект: $PROJECT";
        cd $PROJECT

        if [[ $PROJECT == web4 ]]; then
            sudo make build # Чтобы не выполнять долгие тесты
        elif [[ $PROJECT == sansara ]]; then
            IS_SANSARA=true
        else
            make
        fi

}

function open_or_print_project_link()
{

    if [[ $ORG == "mm-interfaces" ]]; then

        if [[ $PROJECTS =~ sansara ]]; then
            if [[ $PROJECT == sansara ]]; then
                make start
                sleep 1
                open_or_print "http://sansara.ru:8888/images/search?text=Lamborghini"
            fi
        else
            open_or_print "$(wcurl)"
        fi
    fi

}

# ####################
# MAIN LOOP
# ####################

for PROJECT in ${PROJECTS//\\n/ }; do

    echo -e debug "PROJECT:\n" "$PROJECT"

    setup_repo_variables

    mkdir ~/$WC_NAME
    cd ~/$WC_NAME

    clone_repo

    create_symlinks

    NEXT_ACTIONS_HINT="$NEXT_ACTIONS_HINT\ncd $PROJECT_DIR"

    if [[ $IS_MAKE ]]; then
        build_project
    else
        NEXT_ACTIONS_HINT="$NEXT_ACTIONS_HINT && make"
    fi

    open_or_print_project_link

done


# ####################
# HINTS
# ####################


# Если развёрнута sansara, то собрать её в последнюю очередь,
# Чтобы были доступны уже собранные проекты
[[ $IS_MAKE && $IS_SANSARA ]] && cd ~/$WC_NAME/sansara && sudo make install # а просто make запускает сервер и браузер

# Вывести подсказки по дальнейшим действиям
echo -e "$NEXT_ACTIONS_HINT\033[0m"

# Создаем tmux-сессию для последнего проекта из цикла
if [[ $IS_TMUX == 1 ]]; then
    cd $PROJECT_DIR
    tmux -2 -S /tmp/tm-`whoami` new-session -s $WC_NAME "tmux source-file ~/dotfiles/.tmux-default-session-$ORG_ALIAS"
fi
